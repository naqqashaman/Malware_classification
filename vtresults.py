import simplejson
import urllib
import urllib2
import sys
import csv
import os
import re
import math
api_key_index = 0
API_KEY_LIST =  []
#'../Untitled.csv' '../analyse.csv' './res_vt.txt'

def open_csv_write(filename):
#open CSV File to write
    try:
        new_csv = csv.writer(open(filename,"w"))
    except IOError:
        pass
    return new_csv

def hashes_report(s_hashes,report_file,error_file):
    retry = 3
    global api_key_index
    while retry:
        try:
            url = "https://www.virustotal.com/vtapi/v2/file/report"
            parameters = {"resource": s_hashes, 
            "apikey": API_KEY_LIST[api_key_index]}
            data = urllib.urlencode(parameters)
            req = urllib2.Request(url, data)
            response = urllib2.urlopen(req)
            json = response.read()
            print json
            if len(json) < 80:
                print "Json error response"
                print json
                raise
            retry = 0
            f = open (report_file,'w+')
            f.write(json)
            f.seek(0)
            #results is a string of scans of all hashes
            f_results= f.read()
            f.close()
            api_key_index  = api_key_index +1
            if api_key_index == len(API_KEY_LIST):
                api_key_index = 0
            return f_results
        except Exception as err:
            retry = retry - 1
            print err
            if retry == 0:
                s_hashes_temp = s_hashes.replace(',', '\n')
                error_file.write(md5s)
                error_file.write('\n')
                error_file.flush()       
            api_key_index  = api_key_index +1
            if api_key_index == len(API_KEY_LIST):
                api_key_index = 0
            
    return ""
def rm_invalid_text(f_results):
    invalid_text = re.findall(r'\s*\{("response_code.*?)"\}', f_results)
    results= f_results
    i=0
    while i<len(invalid_text):
        results= results.replace(invalid_text[i],'')
        i+=1
    return results, invalid_text

def extract_invalid_hashes(invalid_text):    
    invalid_text= ','.join(invalid_text)
    invalid_md5s = re.findall(r'\s"resource":\s"(.*?)",\s', invalid_text)
    return invalid_md5s

def extract_data(results):
#result is a list of scans of all hashes. i.e.[scan1,scan2,.....]
#where scan1 is a string '.....................'
    result= results.split('{"scans": {')
#split_result is a list of list of all hashes. i.e. [scan1,scan2,.....]
#where scan1 is a list =['...','...',....]
    split_result=['NULL']
    matches=['Matches']
    scan_date=['Scan_Date_Time']
    comments= ['comments']
    v_md5s = re.findall(r'\s"resource":\s"(.*?)",\s', results)
    v_md5s.insert(0,'md5_sum')
    count=1
    while count<len(result):
        detected= re.search(' "positives": (\d+)', result[count])
        matches.append(detected.group(1))
        #final.write(detected.group(1) + ', ')
        s_d= re.search(' "scan_date": "(\d+-\d+-\d+ \d+:\d+:\d+)"', result[count])
        scan_date.append(s_d.group(1))
        #final.write(scan_date.group(1) + ', ')
        split_result.append(result[count].split('}, '))
        #-------------------------Filters------------------------------------
        flag=0
        rees= re.search(r'SuperScan',result[count],re.IGNORECASE)
        if rees:
            comments.append(rees.group(0)+';not a virus')
            flag=1
        rees= re.search(r'DNAScan',result[count],re.IGNORECASE)
        if flag==0:    
            if rees:
                comments.append('DNAScan; not a virus')
                flag=1
        rees= re.search(r'joke',result[count],re.IGNORECASE)
        if flag==0:    
            if rees:
                comments.append('joke; not a virus')
                flag=1
        rees= re.search(r'not.a.virus',result[count],re.IGNORECASE)
        if flag==0:    
            if rees:
                comments.append('not a virus')
                flag=1
    #---------------------Adware in satistics has been counted as 'adware,'
    #so care must be taken while calculating stats; may be the string is to be modified to be modified
        rees= re.findall(r'ad[wi]',result[count],re.IGNORECASE)
        if flag==0:    
            if rees:
                per= (len(rees)*100)/int(detected.group(1))
                if per>=20:
                    comments.append('adware: ' + str(len(rees))+ '::' + str(per) + '%')
                else:
                    comments.append('adware detail analysis required: ' + str(len(rees))+ '::' + str(per) + '%')
                flag=1
        rees= re.search(r'hacktool',result[count],re.IGNORECASE)
        if flag==0:    
            if rees:
                comments.append('Hack Tool;not a virus')
                flag=1
        rees= re.search(r'DNS(.*?)Changer',result[count],re.IGNORECASE)
        if flag==0:    
            if rees:
                comments.append('DNSChanger;not a virus')
                flag=1
        rees= re.search(r'PC(.*?)Client',result[count],re.IGNORECASE)
        if flag==0:    
            if rees:
                comments.append('PC_Client;not a virus')
                flag=1
        
        if flag==0:    
            comments.append('')
        count+=1


    #In split_result[] the last two elements/strings are useless    
    list_of_strues=['AV:Results']
    list_of_sresults=['Results']
    list_of_sAVs=['AVs']
    trues=[]
    results_only=[]
    AV_only=[]
    # count is for complete scan of one hash
    count=1
    # split_count is for details of one hash
    split_count=0
    
    while count<len(result):
        while split_count<len(split_result[count]):
            res= re.findall(r'"(.*?)":.*?true.*?"result":\s"(.*?)"',split_result[count][split_count])
            if res!=[]:
                trues.append( res[0][0]+':'+res[0][1])
                results_only.append(res[0][1])
                AV_only.append(res[0][0])
            split_count+=1
        split_count=0
        s_trues=';'.join(trues)
        s_res=';'.join(results_only)
        s_AV=';'.join(AV_only)
        list_of_strues.append(s_trues)
        list_of_sresults.append(s_res)
        list_of_sAVs.append(s_AV)
        trues=[]
        results_only=[]
        AV_only=[]
        count+=1
    return v_md5s,scan_date,matches,comments,list_of_strues,list_of_sresults,list_of_sAVs


def write_data(csv_writer, results, invalid_text):
    (v_md5s,scan_date,matches,comments,list_of_strues,list_of_sresults,list_of_sAVs)= extract_data(results)
    invalid_md5s= extract_invalid_hashes(invalid_text)
    count=1
    while count<len(v_md5s):
        csv_writer.writerow((v_md5s[count],matches[count],comments[count],list_of_strues[count],list_of_sresults[count],list_of_sAVs[count]))
        count+=1
    count=0
    while count<len(invalid_md5s):
        csv_writer.writerow((invalid_md5s[count],'Not Available','Not Available','The requested resource is not among the finished, queued or pending scans'))
        count+=1
def main():
  # Make a list of command line arguments, omitting the [0] element
  # which is the script itself.
 # args = sys.argv[1:]
 # if args==['']:
  #------Change Filename
  if len(sys.argv) != 4:
    print "usage is python <md5list> <outfile.csv> <error_md5s>"
    print "usage example 'python imp_auto_vt_results.py ./md5_Nov08.txt ./Analysis_Nov08.csv ./error_md5s.txt"
  args = sys.argv[1:]
  print args
    #'../Untitled.csv' '../analyse.csv' './res_vt.txt'
    #'../fn_md5.txt' '../analyse.csv' './res_vt.txt'
  
  if len(args)==3:
    read_filename= args[0]
    write_csv_filename= args[1]
    error_text_file= args[2]
    report_text_file= './temp_vt_results.txt'
    f= open(read_filename)
    error_file = open(error_text_file, 'w')
    text=f.read()
    text= text.replace('\n',',')
    text= text.replace('\r',',')
    hashes= text.split(',')
    hashes= hashes[:-1]
    
    csv_writer= open_csv_write(write_csv_filename)
    csv_writer.writerow(("md5sum","matches","comments","AV_Results","Results_Only","AV_Names"))
    print len(hashes)
    divisions= math.ceil(len(hashes)/float(4))
    count = 1
    index= 0
    while count < divisions:
        print '---------------------'+ str (count)+'-----------------'
        s_hashes= ','.join(hashes[index:index+4])
        f_results= hashes_report(s_hashes,report_text_file,error_file)
        (results, invalid_text)=rm_invalid_text(f_results)
        write_data(csv_writer, results, invalid_text)
        index+=4
        count+=1
    print '---------------------'+ str (count)+'-----------------'
    s_hashes= ','.join(hashes[index:])
    f_results= hashes_report(s_hashes,report_text_file,error_file)
    (results, invalid_text)=rm_invalid_text(f_results)
    write_data(csv_writer, results, invalid_text)


    print 'Results are written to '+ write_csv_filename + ' successfully'
  else :
    print "error: please specify all the filenames and paths correct dirs"
    sys.exit(1)
if __name__ == '__main__':
  main()
