import simplejson
import urllib
import urllib2
import socket
import sys
from time import sleep
# Need to run the script using python rescan.py <hashes_file>

API_KEY_LIST =  []
api_key_index = 0

input_file = sys.argv[1]
f = open(input_file, 'r')

error_file = open('error_hash.txt', 'a')

socket.setdefaulttimeout(60)
while 1:
  end = 0
  md5s = []
  for a in range(25):
    x = f.readline()
    if len(x) != 0:
      md5s.append(x)
    else:
      end = 1
      break;
  md5s = ','.join(md5s)
  md5s = md5s.replace('\n','')
  if len(md5s) == 0 :
    break
  retry = 3
  while retry:
    print retry
    try:
      
      url = "https://www.virustotal.com/vtapi/v2/file/rescan"
      parameters = {"resource": md5s,"apikey": API_KEY_LIST[api_key_index]}
      data = urllib.urlencode(parameters)
      print data
      print "sending request"
      req = urllib2.Request(url, data)
      print "getting response"
      response = urllib2.urlopen(req)
      json = response.read()
      print "Response length", len(json)
      if len(json) < 80:
         print 'Invalid response received'
         print json
         raise
      retry = 0
    except Exception as err:
      print err
      retry = retry-1
      if retry == 0:
        print "Failure after 3 attemps"
        md5s = md5s.replace(',','\n')
        error_file.write(md5s)
        error_file.write('\n')
        error_file.flush()
        api_key_index = api_key_index + 1
        if api_key_index == len(API_KEY_LIST):
          api_key_index = 0
        sleep(5) 
      else:
        api_key_index = api_key_index + 1
        if api_key_index == len(API_KEY_LIST):
          api_key_index = 0
        sleep(5)
        print "retrying in 5 seconds \n" 
        sleep(5)
  if end:
    break;
f.close()
error_file.close()


