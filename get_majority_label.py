import sys
import csv
import re

MINIMUM_TAG_CHARS = 4
FILTER_WORDS = ['\d*']
FILTER_TOKENS = ['Dos', 'Agent', 'Trj', 'win', 'Downloader', 'clicker', 'java', 'Trojan',  'Generic', 'Suspicious',
                 'win32']
AV_PRIORITY = ['Microsoft', 'Kaspersky', 'McAfee', 'Avira', 'Symantec', 'Avast', 'F-Secure', 'AhnLab-V3',]

def get_counts_dict(tokens):
    my_dict = {}
    for item in tokens:
        if item in my_dict.keys() and len(item)>=MINIMUM_TAG_CHARS:
            my_dict[item] += 1
        else:
            my_dict[item] = 0
    return my_dict

def filter_tokens(tokens):
    for token in FILTER_TOKENS:
        for item in tokens:
            if token.upper() == item.upper():
              tokens.remove(item)
    return tokens

def filter_results(line):
    for regex in FILTER_WORDS:
        line = re.sub(regex, '', line, flags=re.IGNORECASE)
    return line

def get_result(results):
    results_mod = filter_results(results)
    tokens = re.split('[\;\:\/!_\.\- ]', results_mod)
    tokens = filter_tokens(tokens)
    results_dict = get_counts_dict(tokens)
    max_key = max(results_dict, key=results_dict.get)

    if results_dict[max_key] > 2:
        return max_key, results_dict[max_key]
    else:
        return priority_result(results), 3

def priority_result(results):
    results = results.replace("\&.+?\;", "")
    if ':' in results:
        av_results_dict = dict(item.split(":",1) for item in results.split(";"))
        for av in AV_PRIORITY:
            if av in av_results_dict.keys():
                tokens = re.split('[\;\:\/!_\.\- ]', av_results_dict[av])
                tokens = filter_tokens(tokens)
                if len(tokens):
                    return max(tokens, key=len)
                return 'Generic'

    return 0

def main():
    out = open("majority_label.txt",'w')
    with open('analysis_result.csv') as csvfile:
        av_reader = csv.reader(csvfile, delimiter=',', quotechar='"')
        print(sys.argv)
        for row in av_reader:
            print(', '.join([row[0], row[3]]))
            av_tag, tag_count = get_result(row[3])
            print(row[0], av_tag)
            out.write("%s,%s\n"%(row[0],av_tag))

if __name__ == "__main__":
    main()
